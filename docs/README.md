# 离散事件燃烧模拟文档
本实验使用 JavaScript 实现了一个简单的离散事件模拟系统，并对火焰传播及救火人员的行为进行了模拟。

## 1. 离散事件模拟

> - /project/events.js
离散事件模拟需要维护一个由事件组成的有序（按时间排序）队列。每次处理队列中的一个事件，然后根据事件的类型和内容，更新系统的状态，并将新的事件加入队列。我们使用了一个简单的 [`EventQueue`](../project/events.js) 类来实现这个功能。

## 2. 火焰传播模拟
本文使用二维格网模型来模拟一片可以燃烧的区域，每一个cell包含三种燃烧状态：未燃烧、燃烧中、燃烧完毕。每个cell的燃烧状态会随着时间的推移而改变，cell处于燃烧状态时会向周围的cell传播火焰，传播火焰的行为是否成狗受到蒙特卡洛模拟（风速、风向等）影响。我们实现了[Cell](../project/cell.js)类和[Grid](../project/grid.js)类来管理格网行为并存储格网数据。

接下来具体介绍火焰传播模型。火焰传播模型[FireSpreadEvent](../project/models/fire.js)继承自Event类，是具体描述火焰传播行为的类。该类依赖环境类传入的，真实世界统计得到的概率分布参数，通过蒙特卡洛模拟的方式，模拟环境参量。

### 2.1 Environment & Distribution
[Distribution](../project/distributions.js)文件主要用来实现一些概率分布的类及蒙特卡洛模拟方法。

- `MonteCarloDistribution` 提供了统一的分布抽象接口，使得不同分布类具有一致的采样和描述方法。
  - 该类是一个抽象基类，定义了 Monte Carlo 模拟中分布类的基本接口。它不能直接实例化，提供了通用的方法结构，要求继承的子类实现以下两个核心方法：
    - **sample()**：抽象方法，生成符合特定分布的随机样本。子类必须实现该方法，以便生成符合其特定分布的随机数。
    - **describe()**：可选的描述方法，用于输出分布的描述信息。子类可选择实现此方法以返回分布的特征信息。
- `GaussianDistribution` 使用 Box-Muller 变换实现正态分布采样，适用于模拟连续的对称分布场景。
  - 该类继承自 `MonteCarloDistribution`，表示高斯（正态）分布。它采用 Box-Muller 变换生成正态分布随机数。此分布的特点是对称于均值，且样本点主要集中在均值附近。
    - **mean**：均值，控制分布的中心位置。
    - **standardDeviation**：标准差，决定分布的宽度（数据的离散程度）。标准差越大，分布越分散；标准差越小，分布越集中。
- `DiscreteDistribution` 使用累积分布实现离散事件的采样，通过定义不同事件的概率来模拟离散分布场景。
  - 该类同样继承自 `MonteCarloDistribution`，用于表示离散分布。它接收一个概率映射，将一组离散事件与其发生概率关联起来。
    - **_buildCumulative()**：内部方法，用于计算累积分布（cumulative distribution function, CDF）。通过累加每个事件的概率，生成一个累积概率数组，供 `sample()` 方法使用。
    - **sample()**：生成符合离散分布的随机样本。通过生成一个随机数，并与累积分布数组进行比较，返回对应的事件。该方法确保采样过程符合设定的概率分布。
    - **describe()**：返回一个包含事件及其概率的字符串描述，用于快速了解分布特征。

结合上述具体的分布类，我们就可以将其统一在一个环境类下，提供给火焰传播模型使用。[Environment](../project/models/environment.js)类主要用来管理火焰传播模型的环境参数，包括风速、风向等。

### 2.2 FireSpreadEvent
#### `FireSpreadEvent` 类
用于模拟火灾蔓延的事件。核心逻辑包括火势扩散、剩余燃烧时间更新、风力对火势影响的计算。
  
- **execute() 方法**：核心方法，执行火灾扩散逻辑。
  - 获取当前单元格状态，若单元格为“未燃烧”状态，则将其标记为“燃烧中”，并基于风速设定燃烧时间。
  - 遍历相邻单元格，并根据风向和火势扩散概率，判断是否触发火势蔓延。
  - 若当前单元格燃烧时间耗尽，生成 `BurnOutEvent` 事件；否则，继续生成下一时刻的 `FireSpreadEvent` 事件。
- **calculateSpreadProbability() 方法**：计算火势蔓延到邻居单元格的概率，考虑风向和阻燃性。结果缓存以提升效率。
- **forEachNeighbor() 方法**：遍历并处理相邻单元格，用于扩散逻辑。
- **getDirectionFactor() 方法**：计算风向与邻居方向的夹角，以此调整扩散概率。


在 `FireSpreadEvent` 类的火灾扩散模型中，涉及到多个数学公式，主要用于火势蔓延概率的计算以及风向的影响。

### 1. 火势蔓延概率计算
$$
P_{\text{spread}} = 0.8 \times \cos(\min(\Delta \theta, 2\pi - \Delta \theta)) \times R
$$

其中：
    - $P_{\text{spread}}$：火势蔓延的概率
    - $\cos(\min(\Delta \theta, 2\pi - \Delta \theta))$：风向对火势蔓延的影响因子，计算了火灾蔓延方向和风向之间的夹角 $\Delta \theta$，并根据夹角计算了风向的支持度
    - $\Delta \theta$：夹角由邻居单元格的方向和风向之间的角度差异计算得出
    - $\theta_{\text{neighbor}}$：邻居单元格相对于当前单元格的方向角度
    - $\theta_{\text{wind}}$：风向对应的角度，根据预定义的风向对应值进行映射
    - $R$：邻居单元格的阻燃系数，表示该单元格的耐火能力，通常是一个介于 0 和 1 之间的值
    - 常数系数 0.8 用于控制概率的尺度，确保计算的蔓延概率在合理范围内。
火焰蔓延概率 $P_{\text{spread}}$ 由风向影响因子、邻居单元格的阻燃系数和常数系数共同决定。
1. 风向影响因子：$\cos(\min(\Delta \theta, 2\pi - \Delta \theta))$，表示风向对火势蔓延的影响程度。夹角 $\Delta \theta$ 表示邻居单元格的方向与风向之间的角度差异，通过余弦函数计算支持度。
2. 阻燃系数：$R$，表示邻居单元格的阻燃系数，取值范围为 $[0, 1]$，值越大，火势蔓延的难度越大。
3. 常数系数：$0.8$，用于控制概率的尺度，确保计算的蔓延概率在合理范围内。

通过这些因素的综合作用，可以模拟火灾在网格中蔓延的过程，考虑风速、风向及邻居单元格的阻燃能力等环境因素对火势扩散的影响。

1. **风向角度转换**：
   - 预定义风向对应的角度如下：

    | 风向 | 角度 |
    | --- | --- |
    | "N" | $\frac{-\pi}{2}$ |
    | "NE" | $\frac{-\pi}{4}$ |
    | "E" | $0$ |
    | "SE" | $\frac{\pi}{4}$ |
    | "S" | $\frac{\pi}{2}$ |
    | "SW" | $\frac{3\pi}{4}$ |
    | "W" | $\pi$ |
    | "NW" | $\frac{-3\pi}{4}$ |

## 3. 消防员救火模拟

## 4. 统计与分析